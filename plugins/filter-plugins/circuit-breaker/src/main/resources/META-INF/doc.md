# 功能

此插件实现熔断功能，在因上游服务可能发生异常，导致网关连续收到状态码为`500`或者一些其他表示内部错误的状态码时，网关进入熔断状态，直接告知客户端API进入熔断状态，从而防止造成上游服务异常雪崩。

此插件暂只支持在单个网关节点内维护熔断状态，不和相同环境下的其他网关节点联动共享状态，因此配置参数未变化的情况下，网关节点数的变化会影响实际熔断效果。

# 配置

此插件的配置参数较多，在理解如何配置之前，先简要说明此插件的处理流程。

熔断器有3种状态：

- 关闭
- 打开
- 半开

最初熔断器处于关闭状态，此插件会收集上游返回的状态码，如果状态码在配置的集合范围内，会判断是否触发熔断条件：在最近一段时间范围内，异常响应的个数是否已经达到的阈值。若条件满足，熔断器进入打开状态。

在打开状态，所有发送到网关的请求。网关都会直接返回 `503 Service Unavailable`，即服务暂时不可用的提示。打开状态会持续一段时间，时长取决于配置。

打开状态的持续时间结束后，熔断器进入到半开状态，在半开状态下，网关将收到的请求路由到上游，若上游返回正常，则请求正常，若上游返回异常，则网关认为上游还未完全恢复，熔断器会立即重新进入打开状态，将再次持续一段时间后在进入到半开状态。若在指定的半开状态持续时长范围内，网关没有收到过上游返回的异常，则半开状态结束，熔断器进入关闭状态。另外，若虽然时间长度未达到，但是连续正常的请求个数达到配置的阈值，也会结束半开状态进入关闭状态。

配置参数如下：

- failureCodes

  配置熔断器关注的异常响应码，需要是一个数组，数组元素为正整数，一般为 `5` 开头的状态码，例如: `[500, 501, 503, 504]`

- failureCountThreshold
  
  触发熔断器从关闭状态进入到打开状态需要累积的失败异常响应码个数。只会收集最近一段时间，不是无限时长累积，时长由其他参数配置。

- slidingWindowSize

  累积异常状态码个数的时间窗口大小。单位为秒。

- minimumCalls

  触发熔断器从关闭状态进入到打开状态需要的最小请求总数。需要是一个大于等于 `failureCountThreshold` 的值。若熔断器从关闭状态进入到打开状态，处理异常响应的个数达到设定的阈值，期间总请求的个数也要达到设定的阈值。

- openStateDuration
  
  熔断器打开状态持续时长，单位为秒。

- halfOpenStateCalls

  结束半开状态进入到关闭状态需要的连续正常请求个数。

- halfOpenStateDuration

  熔断器半开状态持续时长，单位为秒。

# 例子

```json
{
    "failureCodes": [500],
    "failureCountThreshold": 50,
    "slidingWindowSize": 100,
    "minimumCalls": 100,
    "openStateDuration": 60,
    "halfOpenStateCalls": 20,
    "halfOpenStateDuration": 30
}
```